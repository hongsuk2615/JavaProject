<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <script th:src="@{/js/common.js}"></script>
</head>
<body>

<div class="sidebar">
    <a href="/"><h2>Tech Stack</h2></a>
    <ul>
        <li><a href="/crud">CRUD</a></li>
        <li><a href="/auth">Auth</a></li>
        <li><a href="/kafka">Kafka</a></li>
        <li><a href="/ci">CI/CD</a></li>
    </ul>
</div>

<div class="content">
    <!-- 게시글 카드 -->
    <div class="board-card">
        <h2 id="title">게시글 제목</h2>
        <div class="board-meta">
            작성자: <span id="author"></span> | 작성일: <span id="createdAt"></span>
        </div>
        <div class="board-content" id="content">내용이 표시됩니다.</div>

        <div class="mt-3">
            <div class="d-flex justify-content-end">
                <button class="btn btn-outline-light btn-sm btn-icon" id="editBtn" title="수정">
                    <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm btn-icon mx-2" id="deleteBtn" title="삭제">
                    <i class="bi bi-trash"></i>
                </button>
                <button class="btn btn-secondary btn-sm btn-icon" onclick="history.back()" title="목록으로 돌아가기">
                    <i class="bi bi-arrow-left"></i>
                </button>
            </div>

        </div>
    </div>

    <div class="mt-4">
        <h5>댓글</h5>
        <div class="reply-input-container">
            <textarea id="replyInput" class="form-control" rows="2" placeholder="댓글을 작성하세요"></textarea>
            <button class="btn btn-info btn-icon" id="addReplyBtn" title="댓글 작성" style="width: 4rem; height: 4rem;" onclick="addReply()"><i class="bi bi-send"></i></button>
        </div>
    </div>

    <div id="replyList" class="mt-3"></div>
</div>

<script>
    const boardId = window.location.pathname.split('/').pop();

    async function loadBoard() {
        try {
            const res = await fetch(`/api/board/${boardId}`);
            if (!res.ok) throw new Error('게시글 불러오기 실패');
            const board = await res.json();

            document.getElementById('title').innerText = board.title;
            document.getElementById('createdAt').innerText = new Date(board.createdAt).toLocaleString();
            document.getElementById('content').innerText = board.content;

            const authorElem = document.getElementById('author');
            authorElem.innerHTML = '';
            authorElem.appendChild(createAuthorElement(board.authorEmail, board.authorProvider));

            document.getElementById('editBtn').onclick = () => window.location.href = `/crud/board/edit/${board.id}`;
            document.getElementById('deleteBtn').onclick = () => deleteBoard(board.id);
        } catch (err) {
            console.error(err);
            alert('게시글 로드 실패');
        }
    }


    async function loadReplies() {
        try {
            const res = await fetch(`/api/board/${boardId}/replies`);
            if (!res.ok) throw new Error('댓글 로드 실패');
            const replies = await res.json();

            const replyList = document.getElementById('replyList');
            replyList.innerHTML = '';

            replies.forEach(reply => {
                const card = createReplyCard(reply);
                replyList.appendChild(card);
            });
        } catch (err) {
            console.error(err);
        }
    }
    async function deleteBoard(id) {
        if (!confirm('정말 삭제하시겠습니까?')) return;
        try {
            const res = await fetch(`/api/board/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'include'
            });

            if (res.ok) {
                alert('삭제되었습니다.');
                window.location.href = '/crud';
            } else if (res.status === 403 ) { //작성자가 아닐경우
                const msg = await res.text();
                alert(msg);
            } else if (res.status === 401) {
                alert('로그인이 필요합니다.');
                window.location.href = '/auth/login';
            }else {
                alert('삭제 실패!');
            }
        } catch (err) {
            console.error(err);
            alert('삭제 중 오류가 발생했습니다.');
        }
    }

    function createReplyCard(reply, isNested = false) {
        const div = document.createElement('div');
        div.className = isNested ? 'reply-card reply-container' : 'reply-card';

        const meta = document.createElement('div');
        meta.className = 'reply-meta';

        const authorElem = createAuthorElement(reply.authorEmail, reply.authorProvider);
        meta.appendChild(authorElem);
        meta.appendChild(document.createTextNode(` | ${new Date(reply.createdAt).toLocaleString()}`));
        div.appendChild(meta);

        const content = document.createElement('div');
        content.className = 'reply-content';
        content.innerText = reply.content;
        div.appendChild(content);

        const actions = document.createElement('div');
        actions.className = 'reply-actions';

        const replyBtn = document.createElement('button');
        replyBtn.className = 'btn btn-outline-light btn-sm me-2';
        replyBtn.innerHTML = `<i class="bi bi-reply"></i>`;
        replyBtn.onclick = () => showReplyInput(reply.id, div);
        actions.appendChild(replyBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-outline-danger btn-sm';
        deleteBtn.innerHTML = `<i class="bi bi-trash"></i>`;
        deleteBtn.onclick = () => deleteReply(reply.id);
        actions.appendChild(deleteBtn);

        div.appendChild(actions);

        if (reply.replies && reply.replies.length > 0) {
            reply.replies.forEach(r => {
                const nestedCard = createReplyCard(r, true);
                div.appendChild(nestedCard);
            });
        }

        return div;
    }

    function showReplyInput(parentId, parentDiv) {
        const existing = parentDiv.querySelector('.reply-input-container');
        if (existing) existing.remove();

        const container = document.createElement('div');
        container.className = 'reply-input-container mt-2';
        const textarea = document.createElement('textarea');
        textarea.className = 'form-control';
        textarea.rows = 2;
        textarea.placeholder = '답글 작성...';

        const btn = document.createElement('button');
        btn.className = 'btn btn-info';
        btn.innerHTML = `<i class="bi bi-send"></i>`;
        btn.style = 'width:4rem; height:4rem;';
        btn.onclick = () => {
            addReply(parentId, textarea.value);
            container.remove();
        };

        container.appendChild(textarea);
        container.appendChild(btn);
        parentDiv.appendChild(container);
    }

    async function addReply(parentId = null, content = null) {
        const input = content || document.getElementById('replyInput').value.trim();
        if (!input) return;

        try {
            const res = await fetch(`/api/board/${boardId}/replies`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ content: input, parentId }),
                credentials: 'include'
            });
            console.log(res);

            if (res.status === 401) {
                const data = await res.json().catch(() => null);
                const msg = data?.message || '로그인이 필요합니다.';
                alert(msg);
                // window.location.href = '/auth/login';
                return;
            }



            if (!res.ok) {
                const msg = await res.text();
                alert(msg);
                return;
            }

            if (!content) document.getElementById('replyInput').value = '';
            loadReplies();
        } catch (err) {
            console.error(err);
            alert('댓글 작성 실패');
        }
    }

    async function deleteReply(replyId) {
        if (!confirm('댓글을 삭제하시겠습니까?')) return;

        try {
            const res = await fetch(`/api/replies/${replyId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (res.ok) loadReplies();
            else {
                const msg = await res.text();
                alert(msg);
            }
        } catch (err) {
            console.error(err);
            alert('댓글 삭제 실패');
        }
    }
    loadBoard();
    loadReplies();

</script>
</body>
</html>
