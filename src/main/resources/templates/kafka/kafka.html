<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>실시간 채팅 & 로그</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">

    <style>
        .panel {
            background: #1e293b;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .chat-messages, .log-messages {
            height: 250px;
            overflow-y: auto;
            padding: 0.5rem;
            background: #0f172a;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        .chat-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .chat-input textarea {
            flex: 1;
            resize: none;
            border-radius: 8px;
            padding: 0.5rem;
            background: #1e293b;
            color: #f8fafc;
            border: 1px solid #38bdf8;
        }
        .chat-input button {
            width: 4rem;
            height: 4rem;
        }
        .author-container {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .provider-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .my-message {
            background-color: #dcf8c6;
            color: #000;
            padding: 0.5rem 0.8rem;
            border-radius: 16px 16px 0 16px;
            text-align: right;
            margin: 4px 0;
            max-width: 70%;
            float: right;
            clear: both;
            word-break: break-word;
        }

        .other-message {
            background-color: #f1f0f0;
            color: #000;
            padding: 0.5rem 0.8rem;
            border-radius: 16px 16px 16px 0;
            text-align: left;
            margin: 4px 0;
            max-width: 70%;
            float: left;
            clear: both;
            word-break: break-word;
        }

        .message-time {
            font-size: 0.7em;
            color: #555;
            margin-top: 2px;
        }
    </style>
</head>
<body>
<div class="sidebar">
    <a th:href="@{/}"><h2>Tech Stack</h2></a>
    <ul>
        <li><a th:href="@{/crud}">CRUD</a></li>
        <li><a th:href="@{/auth}">Auth (JWT + OAuth2)</a></li>
        <li><a th:href="@{/kafka}">Kafka</a></li>
        <li><a th:href="@{/ci}">CI/CD</a></li>
    </ul>
</div>
<div class="content mt-4">

    <!-- 채팅 패널 -->
    <div class="panel">
        <h4>실시간 채팅 (WS + Kafka)</h4>
        <div id="chatMessages" class="chat-messages"></div>

        <div class="chat-input mt-2">
            <textarea id="chatInput" rows="2" placeholder="메시지를 입력하세요"></textarea>
            <button class="btn btn-info" onclick="sendChat()"><i class="bi bi-send"></i></button>
        </div>
    </div>

    <div class="panel">
        <h4>실시간 로그(Kafka)</h4>
        <div id="logContainer" class="log-messages"></div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    // 클라이언트 ID (로컬스토리지) + 서버 IP
    let clientId = localStorage.getItem('clientId');
    if (!clientId) {
        clientId = generateUUID();
        localStorage.setItem('clientId', clientId);
    }

    // WebSocket 연결
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
        console.log("WS Connected");
        stompClient.subscribe('/topic/messages', (msg) => {
            const chatDiv = document.getElementById('chatMessages');
            const message = JSON.parse(msg.body);

            const p = document.createElement('div');
            // clientId 비교 → 본인인지 타인인지
            if (message.clientId === clientId) {
                p.className = 'my-message';
                p.innerHTML = `나(${message.clientIp}) : ${message.content}`;
            } else {
                p.className = 'other-message';
                p.innerHTML = `익명(${message.clientIp}) : ${message.content}`;
            }

            chatDiv.appendChild(p);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });
    }, (error) => {
        console.error("WS Error", error);
    });

    function sendChat() {
        const input = document.getElementById('chatInput');
        if (!input.value.trim()) return;

        fetch('/api/client-info')  // 서버에서 IP 반환
            .then(res => res.json())
            .then(data => {
                stompClient.send("/app/chat.send", {}, JSON.stringify({
                    clientId: clientId,
                    clientIp: data.ip,
                    content: input.value
                }));
                input.value = '';
            });


    }

    // SSE 로그
    const logContainer = document.getElementById('logContainer');
    const evtSource = new EventSource("/logs/stream");

    evtSource.onmessage = (event) => {
        const p = document.createElement('div');
        p.innerText = `[${new Date().toLocaleTimeString()}] ${event.data}`;
        logContainer.appendChild(p);
        logContainer.scrollTop = logContainer.scrollHeight;
    };

</script>
</body>
</html>
