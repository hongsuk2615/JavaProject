<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>실시간 채팅 & 로그</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">

    <style>
        .panel { background: #1e293b; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2);}
        .chat-messages, .log-messages { height: 250px; overflow-y: auto; padding: 0.5rem; background: #0f172a; border-radius: 8px; font-family: monospace; font-size: 0.85rem;}
        .chat-input { display: flex; gap: 0.5rem; margin-top: 0.5rem;}
        .chat-input textarea { flex: 1; resize: none; border-radius: 8px; padding: 0.5rem; background: #1e293b; color: #f8fafc; border: 1px solid #38bdf8;}
        .chat-input button { width: 4rem; height: 4rem;}
        .my-message { background-color: #dcf8c6; color: #000; padding: 0.5rem 0.8rem; border-radius: 16px 16px 0 16px; text-align: right; margin: 4px 0; max-width: 70%; float: right; clear: both; word-break: break-word;}
        .other-message { background-color: #f1f0f0; color: #000; padding: 0.5rem 0.8rem; border-radius: 16px 16px 16px 0; text-align: left; margin: 4px 0; max-width: 70%; float: left; clear: both; word-break: break-word;}
    </style>
</head>
<body>
<div class="sidebar">
    <a th:href="@{/}"><h2>Tech Stack</h2></a>
    <ul>
        <li><a th:href="@{/crud}">CRUD</a></li>
        <li><a th:href="@{/auth}">Auth (JWT + OAuth2)</a></li>
        <li><a th:href="@{/kafka}">Kafka</a></li>
        <li><a th:href="@{/ci}">CI/CD</a></li>
    </ul>
</div>
<div class="content mt-4">

    <!-- 채팅 패널 -->
    <div class="panel">
        <h4>실시간 채팅 (WS + Kafka)</h4>
        <div id="chatMessages" class="chat-messages"></div>

        <div class="chat-input mt-2">
            <textarea id="chatInput" rows="2" placeholder="메시지를 입력하세요"></textarea>
            <button class="btn btn-info" onclick="sendChat()"><i class="bi bi-send"></i></button>
        </div>
        <div class="mt-2">
            <button class="btn btn-warning" onclick="sendBulkTest()">부하 테스트</button>
        </div>
    </div>

    <div class="panel">
        <h4>실시간 로그(Kafka)</h4>
        <div id="logContainer" class="log-messages"></div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    const CHAT_MAX_LINES = 500;
    const LOG_MAX_LINES = 1000;
    const QUEUE_MAX_BATCH = 500; // 큐 최대 길이
    const RENDER_INTERVAL_MS = 100;

    const chatDiv = document.getElementById('chatMessages');
    const logDiv = document.getElementById('logContainer');

    let chatQueue = [];
    let logQueue = [];
    let chatMessages = [];
    let logMessages = [];

    function appendMessages(container, messages, maxLines) {
        messages.forEach(msg => container.push(msg));
        if(container.length > maxLines){
            container.splice(0, container.length - maxLines);
        }
        return container.map(m => `<div class="${m.className || ''}">${m.text}</div>`).join('');
    }

    // 배치 렌더링
    setInterval(() => {
        if(chatQueue.length > 0){
            if(chatQueue.length > QUEUE_MAX_BATCH){
                chatQueue = chatQueue.slice(-QUEUE_MAX_BATCH);
            }
            chatDiv.innerHTML = appendMessages(chatMessages, chatQueue, CHAT_MAX_LINES);
            chatQueue = [];
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        if(logQueue.length > 0){
            if(logQueue.length > QUEUE_MAX_BATCH){
                logQueue = logQueue.slice(-QUEUE_MAX_BATCH);
            }
            logDiv.innerHTML = appendMessages(logMessages, logQueue, LOG_MAX_LINES);
            logQueue = [];
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    }, RENDER_INTERVAL_MS);

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    let clientId = localStorage.getItem('clientId');
    if (!clientId) {
        clientId = generateUUID();
        localStorage.setItem('clientId', clientId);
    }

    // WebSocket 연결
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
        console.log("WS Connected");
        stompClient.subscribe('/topic/messages', (msg) => {
            const message = JSON.parse(msg.body);
            let text = message.clientId === clientId ?
                `나(${message.clientIp}) : ${message.content}` :
                `익명(${message.clientIp}) : ${message.content}`;
            let cls = message.clientId === clientId ? 'my-message' : 'other-message';
            chatQueue.push({ text, className: cls });
        });
    }, (error) => console.error("WS Error", error));

    function sendChat() {
        const input = document.getElementById('chatInput');
        if (!input.value.trim()) return;
        fetch('/api/client-info')
            .then(res => res.json())
            .then(data => {
                stompClient.send("/app/chat.send", {}, JSON.stringify({
                    clientId: clientId,
                    clientIp: data.ip,
                    content: input.value
                }));
                input.value = '';
            });
    }

    // SSE 로그
    const evtSource = new EventSource("/logs/stream");
    evtSource.onmessage = (event) => logQueue.push({ text: event.data });

    function sendBulkTest() {
        fetch('/api/client-info')
            .then(res => res.json())
            .then(data => {
                const count = 1000;
                for (let i = 0; i < count; i++) {
                    const message = {
                        clientId: clientId,
                        clientIp: data.ip,
                        content: `테스트 메시지 #${i+1}`
                    };
                    chatQueue.push({ text: message.content, className: 'my-message' });
                    stompClient.send("/app/chat.send", {}, JSON.stringify(message));
                }
            });
    }
</script>
</body>
</html>
